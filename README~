                   
      .-'\
   .-'  `/\                     BOOTCHAIN
.-'      `/\
\         `/\                   - Running multiple bootstraps -
 \         `/\                  
  \    _-   `/\       _.--.
   \    _-   `/`-..--\     )    * Runs bootstraps in a recursive fashion
    \    _-   `,','  /    ,')   * Written in shell code (BASH)
     `-_   -   ` -- ~   ,','    * Only need to add a single line to an
      `-              ,','      * Run scripts/programs from a central
       \,--.    ____==-~          script
        \   \_-~\
         `_-~_.-'
          \-~



Intro
========================================================================
Bootstrap (at least in this case) is a script which loads an other script
or program. This script can be used to setup an environment, download
dependencies or whatever.

Bootchain is a tool that runs many bootstraps for you. This is helpful
if you want for example one bootstrap to run for the whole project and a
second to affect only a portion of it. You achieve this by simply
putting the second bootstrap in a subfolder where you want it to have
effect.

With this workflow you can make your project more intuitive and coherent,
since each bootstrap has effect over the folder where it is and all 
subfolders. So if you have a bootstrap in /myproject/tests/gui, 
you know that that specific bootstrap is doing things (running)
for all the GUI tests, no matter if the test is in a subfolder of a 
subfolder of a subfolder, etc.



Usage
========================================================================
1. Copy bootchain in a folder.
2. Create at least one bootstrap between that folder and the target
   file (the one you will run with bootchain)
3. Run the target file/files with bootchain:

    ./bootchain <target1> <target2> ..



Deeper
========================================================================
You run BOOTCHAIN with:

    ./bootchain <target1> <target2> ..

where <target1>, <target2> etc. are paths to the scripts or programs
you are trying to run. Use absolute paths or relative to the bootchain.

You should have at least one bootstrap file between the target and the
bootchain. The reason is that bootchain doesn't know how to run
the target file. It needs a bootstrap to tell it how.

If you want to run a python script for example you would probably
want a bootstrap that at some point has:

    python $TARGET
    echo ?$

The second line just echoes back the return value of the script run. This
is the default way of returning values to bootchain.



A bit deeper
========================================================================
At least one bootstrap file is needed somewhere in the path of the file
you are trying to run with bootchain.

However you can have multiple bootstrap files in between to create a
chain of bootstraps being run.

Let's have a look at the /tests folder of an actual project:


/tests
  | 
  |-- bootstrap                                   <-- First bootstrap
  |
  |-- bootchain                                   <-- The bootchain script
  |
  '-- gui
  |    |
  |    |-- bootstrap                              <-- Second bootstrap
  |    |
  |    |-- forum
  |    |     |
  |    |     |-- profile.py                       <-- Test file
  |    |     '-- threads.py                       <-- Test file
  |    |
  :    :
  .    .

You can see two bootstrap files. The first will run for all tests (since
it's at root compared with bootchain). The second will run for everything
under the 'gui' folder.

The bootstrap files could look very different depending on what you want
them to do. For example in this case maybe we want to create a Docker
container for all our tests so then the first bootstrap would create a
container and then destroy it:




All this is pure BASH. If it's a bit intimidating, don't worry. You
just have to google around for your case scenario.



BOOTCHAIN will run any bootsrap file it finds on its way (as long as it
has a bootstrap_wait line) and run it in a recursive fashion.


        
Examples
========================================================================
There are examples that you can use to see how things work or use
them as templates in your projects. 

project1 - running a few (really) simple tests in python

		   Run with: ./bootchain examples/project1/tests/gui/logged_in/*.py

project2 - running tests in a docker container. you need to have Pithikos's
           docker-enter installed for this to work.
           
           Run with: 

project3 - very deeply nested bootstraps
           
           Run with: ./bootchain examples/project3/a/b/c/d/e/test.py



Running bootchain
========================================================================
./bootchain a/b/c/      --> Runs all bootstraps between folder a and c
./bootchain a/b/c/*     --> Runs all files in folder c (even the
                            bootstrap itself if there is one there)
./bootchain a/b/c/*.py  --> Runs all python files in folder c



API
========================================================================
The only mandatory thing is that you use bootstrap_wait in the
intermediate bootstraps so that a chain of bootstraps is made where
each bootstrap waits for the next one to finish.

The last bootstrap will automatically omit bootstrap_wait if it is
present.


    # SETUP STUFF
	
    bootstrap_wait
    
    # CLEANUP STUFF



Functions
------------------------------------------------------------------------   
bootstrap_wait     Pauses the script until the next bootstrap has finished.
                   Omitting this, makes bootchain assume that this is
                   as the last script and thus will not run any other
                   ones.
                   
                   This can be handy if you're debugging as you just
                   need to remove this line and the bootstrap will be
                   omitted.



Variables
------------------------------------------------------------------------
The below variables are visible from all bootstraps.

TARGET             The name of the file that was given to bootchain.

                   For example if you run ./bootchain a/b/c/script then
                   the TARGET would be 'script'
                   
TARGET_PATH        The path to the target file relative to bootchain.
                   
                   For example if you run ./bootchain a/b/c/script then
                   the TARGET_PATH would be 'a/b/c/script'


* Notice that all variables passed to a bootstrap are in capital to make
  it more aparent that they are part of bootchain.



Scope
------------------------------------------------------------------------
Each bootstrap runs as a separate process. Therefore if you want to achieve
communication between bootstraps, you'll need to use some type of
inter-process communication like signals, FIFOs, files, netcat, etc.

If you are going to use signals, keep in mind that SIGCONT
is already being used by the BOOTCHAIN for synchronisation between proc-
esses.



How it works
========================================================================

If you are calling: ./bootchain 

The flow of how things are being called is:


 BOOTCHAIN            bootstrap                  bootstrap
                      script1                     script2
 ___________           __________________         __________________
|           |         |                  |       |                  |
|           |---------->    do stuff    ---------->   do stuff      |
|           |         |  bootstrap_wait  |       |                  |
|           |<----------    do stuff    <----------    exit 0       |
|___________|         |__________________|       |__________________|
 
In the last bootstrap we omit bootstrap_wait as it's the last bootstrap.
If this is the last bootstrap but you have placed a bootstrap_wait,
the wait will silently be omitted.

bootstrap_wait separates what it has to be done once the bootstrap has
loaded from the things that have to be done when just before it exists (
in most cases cleanup).



Multiple targets
========================================================================
Target is the path you use with bootchain

Essentially you run BOOTCHAIN with a list of paths. The path should
be to the program or script you are trying to run.

BOOTCHAIN will automatically look for bootstrap scripts between itself
and the 



Common uses
========================================================================
This a list of practical uses to give you an idea of when BOOTCHAIN
can be used. Most uses involve running tests since that was the initial
purpose of BOOTCHAIN.

* You want to run tests based on different languages & frameworks from a
  centralized script.

* If you want to setup an environment before running something. For
  example if you want to run many tests in a virtual machine or container.



How it works
========================================================================

Bootchain is simply a script that looks for other scripts named "bootstrap".
The bootstrap files can have whatever extension but their barename should
be bootstrap and nothing more. (This makes it possible for these scripts
to be written in various languages while making it visible what language
they are written in.)

Each bootstrap script is run one-by-one and in the end the testfile is run.
Bootstrap scripts can be written in whatever scripting language you want.

The idea is that each bootstrap script closest to the testfile will have
set the environment correctly for the testfile to run.

The is no constraint as to how many bootscripts you can have. However it's
best to keep it as small as possible for organisational reasons.

The purpose of this design is to make it possible to have a centrelized place
to run all your tests without needing to know how each individual test
should be run. That's up to each bootstrap script to solve for you.




Return value
========================================================================
Every bootstrap file should follow the template:

1. Do whatever
2. [Check ] Run test
3. [Cleanup &] Return code

You, the creator of the bootstrap and each test have to make sure that
each test returns 0 if test passed without any error and any other value
to show that there was an error.

If your bootstraps are in BASH, then you need to use "exit x" to return
the value.



Pass values
========================================================================
Each bootstrap should get at least the value 




Functions
========================================================================
wait_test -> Will set a break point for the script. Everything underneath
will be executed once the test script has been run.




Design notes
========================================================================

Do bootstraps run recursively?
------------------------------------------------------------------------
Bootstraps do behave as if they are running recursively. However
in practice they are run linearly for various reasons. You can still (
and it's encouraged) to think of them as running recursively.


Why execute bootstraps linearly and not recursively?
------------------------------------------------------------------------
The initial idea was to execute the bootstrap scripts recursively. However
that becomes very complex if many files are run. Therefore a linear
way was chosen. Furthermore it's easier to have a communication link
between parent and child.
Even if the implementation is linear, the behaviour is recursive.
bootstrap_wait does wait for the next bootstrap to finish. The only
difference with real recursion is that there is no implicit inheritance
between the bootstraps (which is favorable to not mess things up).


Why ./ (background process) and no . (source)?
------------------------------------------------------------------------
Source can't be used because each bootstrap has to wait for the next.
Source can only be used if you are going to wait for the process to finish.
Ofcourse you could run source with an ampersand (&) to run the whole
thing in a separate process. But then you come back to the same design
that requires synchronisation with the parent.
